---
title: "Optimization to sFLT1 datasets from Hornig, Pulse-chase and Kinghorn"
author: "Amy Gill"
date: "2023-08-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## ---NEW---

## Introduction

This file analyzes data from optimization of the 2 equation sFLT1 DDE model to the pulse-chase and constitutive time course datasets. These data were imported using the script "sFlt-model/analysis-R/draft/candidate_models_import.Rmd".

The optimization was performed 8/10/23 using the Matlab script "sFlt-model/dde_model_v2_072723/dde_candidate_models.m" with following options: 

run_mode = "candidate_model_opt";
pulsechase_cost_option = "omit_last_Sx_relative";
constitutive_cost_option = "relative_omit3h";
kinghorn_cost_option = "all_pts_relative";
num_param_sets = 100;    (# per candidate model)

Optimizing to summary statistics only (mean at each time point) for Kinghorn optimization.

This optimization uses 4 species (I, I_deg, X, X_deg) and optimizes 7 parameters ($\alpha$, $\beta$, $\gamma$, $\delta$, $\epsilon$, $\kappa$, $\tau$) by calculating absolute cost in comparison to all of the following datasets:

- Pulse-chase X (normalized to 8h)
- Pulse-chase I (normalized to 0h)
- Constitutive basal X concentration (absolute, ng/mL -> #/cell)
- Kinghorn X (normalized to 24h)
- Kinghorn I (normalized to 0h)

## Setup

### Load libraries

```{r}
# load libraries
library(tidyverse)
library(patchwork)
library(R.matlab)
library(viridis)
library(GGally)
library(latex2exp)
library(ComplexHeatmap)
```


### Set output file

```{r}
# define folder where output will be saved (for example, png images from ggsave)
outfile_prefix = "../../../saved-figs/02_dde_model/dde_opt/"
dir.create(outfile_prefix, recursive = TRUE)

# specify decimal resolution
options(digits = 4)
```

### Helper functions

#### Define helper functions

*goal: extract into a package*

```{r}
# function to load a colorblind friendly palette
load_cb_pal <- function(){
  
  # define colorblind-friendly palette
# black, red, sky blue, orange, green, yellow, dark blue, pink
  cb_pal <- c("#000000", "#D55E00",  "#56B4E9", "#E69F00", "#009E73", "#F0E442", "#0072B2",  "#CC79A7")
  
  # return color palette
  cb_pal
  
}

# function to set basic plot theme
set_theme1 <- function(){
  
  # define theme basics
  theme1 <- theme_light() +
    theme(
      text = element_text(size = 16),
      plot.title = element_text(hjust = 0.5),
      strip.background =element_rect(fill="gray50"),
      strip.text = element_text(color = "white", face = "bold")
    )
  
  # return theme
  theme1
  
}

# function to create a subdirectory in the current output directory: outfile_prefix/subdir_name/
create_subdir <- function(subdir_name){
  
  # if subdirectory doesn't exist, make it
  if(!(file.exists(paste0(outfile_prefix, subdir_name)))){
    setwd(outfile_prefix)
    dir.create(subdir_name, showWarnings = FALSE)
  }
  
  # return path to desired subdirectory
  paste0(outfile_prefix, subdir_name, "/")
}

# convert string filename to "outfile_prefix/filename.png"
out_png <- function(filename){
  paste0(outfile_prefix, filename, ".png")
}
```

#### Apply helper functions

```{r}
# set theme for all plots
theme1 <- set_theme1()

# define colorblind-friendly palette
# black, red, sky blue, orange, green, yellow, dark blue, pink
cb_pal <- load_cb_pal()
```

### Map parameter names to colors and define resulting color palette (alpha:tau)

```{r}
# map parameter name to index of desired color
param <- list(alpha = 3, beta = 2, gamma = 4, delta = 5, kappa = 7, tau = 8)

# store parameter names
param_names <- names(param)

# create palette for parameters
param_pal <- sapply(1:length(param), function(x){
  cb_pal[unlist(param[param_names[x]])]
})
```

### Import data

#### Optimization runs

```{r}
# load optimization results from 3/7
# (if file is not present, run "candidate_models_import.Rmd" to create it)
load("../../../saved-data/candidate-models/v5_hjk_relative_100/pulsechase_constitutive_opt_sims.rda")
```

#### Experimental data

##### Constitutive X

```{r}
# load experimental data from Hornig
load("../../../saved-data/hornig.rda")

names(hornig) <- str_replace(names(hornig), "Sx", "X")

hornig <- hornig %>%
    filter(condition == "basal", nominal_time != 3)

constitutive_X_ngml_24 <- hornig %>%
  filter(nominal_time == 24) %>%
  pull(X_ng_ml)

hornig <- hornig %>%
  mutate(X_norm_24 = X_ng_ml / constitutive_X_ngml_24)


hornig %>%
    ggplot(aes(nominal_time, X_norm_24)) +
    geom_point(size = 5, color = cb_pal[2]) +
    geom_line(linewidth = 1, color = cb_pal[2]) +
    xlab("Time (h)") +
    ggtitle("Extracellular sFLT1") +
    theme1 +
    scale_x_continuous(n.breaks = 8) +
  scale_y_continuous(name = "Fold change vs 24h",
                     sec.axis = sec_axis(trans = ~.*constitutive_X_ngml_24/conv_factor_numcell_to_ngml,
                                         name = "#/cell"))
```

##### Pulse-chase I, X

```{r}
# load processed Pulse-chase pulse-chase data 
# (if file is not present, run "pulsechase_pulse_chase_1d.Rmd" to create it)
load("../../../saved-data/data-jung-timecourse/jung_1d.rda")

jung <- jung %>%
  filter(!(nominal_time == 10 & target == "media")) %>%
  select(target, nominal_time, sFlt) %>%
  pivot_wider(names_from = "target", values_from = sFlt)

names(jung) <- c("time", "lysate_fc", "media_frac_max")

# plot lysate fold change over time
p1 <- jung %>%
  ggplot(aes(time, lysate_fc)) +
  geom_point(size = 5, color = cb_pal[2]) +
  geom_line(size = 1, color = cb_pal[2]) +
  xlab("Time (h)") +
  ylab("Fold change vs 0h") +
  ggtitle("Intracellular sFLT1 (I)") +
  scale_x_continuous(n.breaks = 6) +
  theme1

# plot media fraction maximum over time
p2 <- jung %>%
  ggplot(aes(time, media_frac_max)) +
  geom_point(size = 5, color = cb_pal[2]) +
  geom_line(size = 1, color = cb_pal[2]) +
  xlab("Time (h)") +
  ylab("Fold change vs 8h") +
  ggtitle("Extracellular sFLT1 (X)") +
  scale_x_continuous(n.breaks = 6) +
  theme1

pulsechase_expt_timecourse <- p2 / p1

pulsechase_expt_timecourse
```

##### Kinghorn I, X

Important: values are mean values

```{r}
kinghorn <- readMat("../../../saved-data/kinghorn_ctrl_summary.mat")

kinghorn <- as.data.frame(kinghorn$kinghorn[,,1])

names(kinghorn) <- str_replace_all(names(kinghorn), "\\.", "_")

# plot lysate fold change over time
k_p1 <- kinghorn %>%
  ggplot(aes(time, I_fc_0h)) +
  geom_point(size = 5, color = cb_pal[2]) +
  geom_line(size = 1, color = cb_pal[2]) +
  xlab("Time (h)") +
  ylab("Fold change vs 0h") +
  ggtitle("Intracellular sFLT1 (I)") +
  scale_x_continuous(breaks = seq(0, 24, by=4)) +
  theme1 +
  ylim(0,1.5)

# plot media fraction maximum over time
k_p2 <- kinghorn %>%
  ggplot(aes(time, X_frac_24h)) +
  geom_point(size = 5, color = cb_pal[2]) +
  geom_line(size = 1, color = cb_pal[2]) +
  xlab("Time (h)") +
  ylab("Fold change vs 24h") +
  ggtitle("Extracellular sFLT1 (X)") +
  scale_x_continuous(breaks = seq(0, 24, by=4)) +
  theme1

kinghorn_expt_timecourse <- k_p2 / k_p1

kinghorn_expt_timecourse
```

##### Constitutive datasets combined

```{r}
hornig %>%
    ggplot(aes(nominal_time, X_norm_24)) +
    geom_point(size = 5, color = cb_pal[2]) +
    geom_line(linewidth = 1, color = cb_pal[2]) +
  geom_point(data = kinghorn, aes(time, X_frac_24h), size = 5, color = cb_pal[7]) +
  geom_line(data = kinghorn, aes(time, X_frac_24h), linewidth = 1, color = cb_pal[7]) +
    xlab("Time (h)") +
    ggtitle("Extracellular sFLT1") +
    theme1 +
    scale_x_continuous(n.breaks = 8) +
  scale_y_continuous(name = "Fold change vs 24h",
                     sec.axis = sec_axis(trans = ~.*constitutive_X_ngml_24/conv_factor_numcell_to_ngml,
                                         name = "#/cell"))
```


## Analysis before preprocessing

### Create formatted data frames for analysis

```{r}
# param_df: a 4-column data frame
# run = run number 1:1000
# parameter = factor, parameter definition(alpha, beta, gamma, delta, epsilon, kappa, tau)
# init_opt = factor, INIT = initial guess, OPT = optimized value
# value = parameter value
param_df <- meta_df %>%
  select(run:OPT_tau) %>%
  pivot_longer(INIT_alpha:OPT_tau, names_to = "parameter", values_to = "value") %>%
  separate(parameter, into = c("init_opt", "parameter"), sep = "_") %>%
  mutate(init_opt = ifelse(init_opt == "INIT", "initial", "optimal"),
                           init_opt = factor(init_opt),
         parameter = factor(parameter,
                            levels = c("alpha", "beta", "gamma", "delta", 
                                       "epsilon", "kappa", "tau"))) 

# add cost to param_df
param_df <- meta_df %>%
  select(run, cost = total_cost) %>%
  right_join(param_df, by = "run")

# extract parameter names
param_names <- levels(param_df$parameter)
```


### Cost distribution

#### Density plot


```{r}
# create function to plot density function of cost
plot_cost_distr_density <- function(df){
  df %>%
    ggplot(aes(total_cost, ..scaled..)) +
    geom_density(fill = cb_pal[3]) +
    #scale_x_log10() +
    scale_x_continuous(trans = "log10", breaks = 10^(-2:5)) +
    theme1 +
    xlab("Sum of squared difference") +
    ylab("Scaled density")
}

# plot cost distribution
combo_cost_distr_unfiltered <- plot_cost_distr_density(meta_df) +
    ggtitle("Cost function values for optimal parameters - all fits")
  
# save plot
ggsave(out_png("combo_cost_distr_unfiltered"),
       combo_cost_distr_unfiltered, width = 9, height = 6)
  
combo_cost_distr_unfiltered
```

#### Violin plot

```{r}
# create function to make violin plot of cost distribution
plot_cost_violin <- function(df){
  df %>%
    ggplot(aes(factor(" "), total_cost)) +
    geom_violin(scale = "width", fill = cb_pal[2]) +   # not trimming b/c hard min value 
    geom_boxplot(width = 0.3, fill = "white") +
    scale_y_continuous(trans = "log10", breaks = 10^(-2:5)) +
    xlab("") +
    ylab("Sum of squared difference") +
    coord_flip() +
    theme1
}

cost_violin <- plot_cost_violin(meta_df) +
  ggtitle("Violin plot of cost function values for optimal parameters")

cost_violin
```

### Filter down to only the base delay model

```{r}
model_num <- meta_df %>%
  filter(prod_decay == "off" & mat_delay == "yes" & internalize == "no") %>%
  pull(candidate_model) %>%
  unique()

constitutive_base_df <- constitutive_full_df %>%
  filter(candidate_model == model_num)

pulsechase_base_df <- pulsechase_full_df %>%
  filter(candidate_model == model_num)

meta_base_df <- meta_df %>%
  filter(candidate_model == model_num)

param_base_df <- param_df %>%
  filter(candidate_model == model_num)
```

### Raw time courses

Individual time courses are colored by the sum of squared differences (SSD) between simulated and observed measurements of both I and X at the experimental time points.

#### Kinghorn X

Some fits have divergent oscillations. For future analysis, impose a cost filter to refine to fits that converge to steady state.

```{r}
constitutive_base_df %>%
  ggplot(aes(t, X_frac)) +
    geom_line(aes(group = run, color = log2(total_cost)), alpha = 0.25) +
  geom_point(data = kinghorn, aes(time, X_frac_24h), size = 5, 
               shape = 21, color = "white", fill = cb_pal[2]) +
    xlab("Time (h)") +
    ylab("X (Normalized to 24h)") +
    labs(color = "log2(Cost)") +
    theme1
```


#### Kinghorn I

Some fits oscillate, others remain constant at the steady state value, and the lowest cost fits initially dip below the steady state value before asymptotically returning to that steady state.

```{r}
constitutive_base_df %>%
  ggplot(aes(t, I_fc)) +
    geom_line(aes(group = run, color = log2(total_cost)), alpha = 0.25) +
  geom_point(data = kinghorn, aes(time, I_fc_0h), size = 5, 
               shape = 21, color = "white", fill = cb_pal[2]) +
    xlab("Time (h)") +
    ylab("I (Normalized to 0h)") +
    labs(color = "log2(Cost)") +
    theme1
```

#### Constitutive X


```{r}
constitutive_plot_X_timecourse_ngml <- function(df){
  df %>%
    ggplot(aes(t, X)) +
    geom_line(aes(group = run, color = log2(total_cost)), alpha = 0.25) +
    geom_point(data = hornig, aes(nominal_time, X_ng_ml), size = 5, 
               shape = 21, color = "white", fill = cb_pal[2]) +
    xlab("Time (h)") +
    ylab("X (ng/mL)") +
    labs(color = "log2(Cost)") +
    theme1
}

constitutive_opt_X_timecourse_ngml_unfiltered <- constitutive_plot_X_timecourse_ngml(constitutive_base_df) +
  ggtitle("Constitutive extracellular sFLT1 (X) - All fits")

ggsave(out_png("constitutive_opt_X_timecourse_ngml_unfiltered"),
       constitutive_opt_X_timecourse_ngml_unfiltered, width = 8, height = 6)

constitutive_opt_X_timecourse_ngml_unfiltered
```

#### Pulse-chase X

```{r}
pulsechase_plot_X_frac_timecourse <- function(df){
  df %>%
    ggplot(aes(t, X_frac)) +
    geom_line(aes(group = run, color = log2(total_cost)), alpha = 0.1) +
        geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    annotate("text", x = -0.75, y = 0.55, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = 0.75, label = "Start chase", angle = 90, size = 6) +
    geom_point(data = jung, aes(time, media_frac_max, fill = "temp"),
               size = 5, shape = 21, color = "white",
               show.legend = TRUE) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +

    ylim(c(-0.05, 1.2)) +
    xlim(c(-1, 10)) +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("X (Normalized to 8h)") +
    labs(color = "log2(Cost)",
         fill = "Observed data") +
    theme1 +
    theme(plot.title = element_text(size = 16))
}

pulsechase_opt_X_timecourse_unfiltered <- pulsechase_plot_X_frac_timecourse(pulsechase_base_df) +
  ggtitle("Pulse-chase extracellular sFLT1 (X) - All fits")

# save plot
ggsave(out_png("pulsechase_opt_X_timecourse_unfiltered"),
       pulsechase_opt_X_timecourse_unfiltered, width = 8, height = 6)

pulsechase_opt_X_timecourse_unfiltered
```


#### Pulse-chase I

```{r}
pulsechase_plot_I_fc_timecourse <- function(df){
  df %>%
    ggplot(aes(t, I_fc)) +
    geom_line(aes(group = run, color = log2(total_cost)), alpha = 0.1) +
        geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    geom_point(data = jung, aes(time, lysate_fc, fill = "temp"),
               size = 5, shape = 21, color = "white", show.legend = TRUE) +
    scale_fill_manual(labels = "I", values = cb_pal[1]) +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("I (Normalized to 0h)") +
    labs(color = "log2(Cost)",
         fill = "") +
    #ylim(c(-0.05, 5)) +
    xlim(c(-1, 10)) +
    theme1 +
    theme(plot.title = element_text(size = 16))
}

pulsechase_opt_I_timecourse_unfiltered <- pulsechase_plot_I_fc_timecourse(pulsechase_base_df) +
    ggtitle("Pulse-chase intracellular sFlt1 (I) - All fits") +
    annotate("text", x = -0.65, y = 0.25, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.25, y = 0.5, label = "Start chase", angle = 90, size = 6)

# save plot
ggsave(out_png("pulsechase_opt_I_timecourse_unfiltered"),
       pulsechase_opt_I_timecourse_unfiltered, width = 8, height = 6)

pulsechase_opt_I_timecourse_unfiltered
```

## Preprocessing

### Define runs to remove

#### Runs that returned NaN cost 

```{r}
runs_to_remove_na <- meta_base_df %>%
  filter(is.nan(c(total_cost))) %>%
  pull(run)

length(runs_to_remove_na)
```

#### Negative species - Constitutive

```{r}
# identify runs where either species goes below 0
runs_neg_constitutive <- constitutive_base_df %>%
  filter(X < 0 | I < 0) %>%
  pull(run) %>%
  unique()

length(runs_neg_constitutive)
```

#### Negative species - Pulse-chase

```{r}
# identify runs where either species goes below 0
runs_neg_pulsechase <- pulsechase_base_df %>%
  filter(X < 0 | I < 0) %>%
  pull(run) %>%
  unique()

length(runs_neg_pulsechase)
```

### Remove runs

```{r}
# remove runs from constitutive simulated time course
constitutive_sims <- constitutive_base_df %>%
  filter(! run %in% runs_to_remove_na & !run %in% runs_neg_pulsechase & !run %in% runs_neg_constitutive) %>%
  mutate(t = round(t,3))

# remove runs from pulse-chase simulated time course
pulsechase_sims <- pulsechase_base_df %>%
  filter(!run %in% runs_to_remove_na & !run %in% runs_neg_pulsechase & !run %in% runs_neg_constitutive) %>%
  mutate(t = round(t,3))

# remove runs from meta_base_df
meta_df_new <- meta_base_df %>%
    filter(!run %in% runs_to_remove_na & !run %in% runs_neg_pulsechase & !run %in% runs_neg_constitutive)

# remove runs from opt_df
opt_df_new <- opt_df %>%
  filter(!run %in% runs_to_remove_na & !run %in% runs_neg_pulsechase & !run %in% runs_neg_constitutive)

# remove runs from param_df
param_df_new <- param_base_df %>%
  filter(!run %in% runs_to_remove_na & !run %in% runs_neg_pulsechase & !run %in% runs_neg_constitutive)
```

```{r}
length(unique(param_df_new$run))
```


### Cost filtering

The best fitting parameter set had a cost of 1.108. We refined our simulations to fits with a cost within 10% of the minimum cost set.

```{r}
min(meta_df_new$total_cost)
```


```{r}
cost_cutoff <- 1.1*min(meta_df_new$total_cost)

sum(meta_df_new$total_cost < cost_cutoff)
```

#### Plot cost distribution with zoom - not currently useful

Saving for reference

```{r}
# initial distribution
p1<- plot_cost_distr_density(meta_df_new) +
  annotate("rect", xmin = 0.75, xmax = 2, ymin = -0.005, ymax = 1.05, color = cb_pal[1], fill = NA, size = 1)

p2 <- plot_cost_distr_density(meta_df_new) +
  xlim(c(0.75,2)) +
  annotate("rect", xmin = 0.85, xmax = 1.2, ymin = 0, ymax = 1.05, size = 2, color = cb_pal[2], fill = NA) +
  annotate("segment", x = 1.8, xend = 1.25, y = 0.9, yend = 0.65, arrow = arrow(), size = 3, color = cb_pal[2])

cost_distr_base_dde_refined <- p1 +
  annotate("rect", xmin = 9, xmax = 1e4, ymin = 0.29, ymax = 1.1, color = cb_pal[1], fill = NA, size = 1) +
  annotate("rect", xmin = 15, xmax = 0.95e4, ymin = 0.3, ymax = 1, fill = "white") +
  annotate("segment", x = 2, xend = 9, y = 1.05, yend = 1.1, lty = 2, color = cb_pal[1]) +
  annotate("segment", x = 2, xend = 9, y = 0, yend = 0.29, lty = 2, color = cb_pal[1]) +
  scale_y_continuous(breaks = seq(0, 1, by = 0.25)) +
  inset_element(p2, 0.3, 0.3, 0.9, 0.9) 

# save plot
ggsave(out_png("cost_distr_base_dde_refined"),
       cost_distr_base_dde_refined, width = 8, height = 6)

cost_distr_base_dde_refined
```

Supplemental figure. Cost distribution of optimizations to the system of delay differential equations in (Figure ref). The inset corresponds to the range in the black box. The red box and arrow note the set fits retained for further analysis.


```{r}
# list low-cost runs from meta_df_new
runs_to_keep <- meta_df_new %>%
  filter(total_cost < cost_cutoff) %>%
  pull(run)

# remove runs from constitutive simulated time course
constitutive_sims <- constitutive_sims %>%
  filter(run %in% runs_to_keep)

# remove runs from pulse-chase simulated time course
pulsechase_sims <- pulsechase_sims %>%
  filter(run %in% runs_to_keep)

# remove runs from meta_df
meta_df_new <- meta_df_new %>%
  filter(run %in% runs_to_keep)

# remove runs from opt_df
opt_df_new <- opt_df_new %>%
  filter(run %in% runs_to_keep)

# remove runs from param_df
param_df_new <- param_df_new %>%
  filter(run %in% runs_to_keep)

# create in wide format
param_df_wide <- param_df_new %>%
  filter(!(parameter %in% c("epsilon", "kappa"))) %>%
  mutate(param_init_opt = paste0(ifelse(init_opt == "initial", "INIT_", "OPT_"), parameter)) %>%
  select(run, param_init_opt, value) %>%
  pivot_wider(names_from = "param_init_opt", values_from = "value")

param_df_wide
```

#### Cost versus run number

```{r}
# visually inspect cost vs run number
# (densities and boxplots were surprisingly uninformative bc of tight distribution)
meta_df_new %>%
  ggplot(aes(as.numeric(run), total_cost)) +
  geom_point(alpha = 0.3) +
  scale_x_continuous(n.breaks = 11) +
  theme1 +
  xlab("Run number") +
  ylab("Sum of squared difference") +
  ggtitle("Cost of fit by run")
```

## --PAUSE 8/20 4pm--

## Analysis of processed data

### Time courses

Individual time courses are colored by the sum of squared differences (SSD) between simulated and observed measurements of both I and X at the experimental time points.

#### Constitutive extracellular sFLT1 (X)

##### Raw values

```{r}
constitutive_opt_X_timecourse_ngml <- constitutive_sims %>%
    ggplot(aes(t, X)) +
    geom_line(aes(group = run), alpha = 0.25) +
    geom_point(data = hornig, aes(nominal_time, X_ng_ml), size = 5, 
               shape = 21, color = "white", fill = cb_pal[2]) +
    xlab("Time (h)") +
    ylab("X (ng/mL)") +
    theme1 +
  ggtitle("Constitutive extracellular sFLT1 (X)")

ggsave(out_png("constitutive_opt_X_timecourse_ngml"),
       constitutive_opt_X_timecourse_ngml, width = 8, height = 6)

constitutive_opt_X_timecourse_ngml
```

##### Normalized

```{r}
constitutive_opt_X_timecourse_norm <- constitutive_sims %>%
  ggplot(aes(t, X_frac)) +
  geom_line(aes(group = run), alpha = 0.25) +
  geom_point(data = hornig, aes(nominal_time, X_norm_24), size = 5, 
             shape = 21, color = "white", fill = cb_pal[2]) +
  xlab("Time (h)") +
  ylab("X (normalized to 24h)") +
  theme1 +
  ggtitle("Constitutive extracellular sFLT1 (X)")

constitutive_opt_X_timecourse_norm
```


```{r}
ggsave(out_png("constitutive_opt_X_timecourse_norm"),
       constitutive_opt_X_timecourse_norm, width = 8, height = 6)
```

#### Constitutive intracellular sFLT1 (I)

##### Absolute numbers

```{r}
constitutive_I_timecourse_fits <- constitutive_sims %>%
    ggplot(aes(t, I)) +
    geom_line(aes(group = run), alpha = 0.2) +
    scale_y_log10() +
    xlab("Time (h)") +
    ylab("I (#/cell)") +
    theme1+
    ggtitle("Constitutive intracellular sFLT1 (I)")

constitutive_I_timecourse_fits
```

```{r}
# save plot
ggsave(out_png("constitutive_I_timecourse_fits"),
       constitutive_I_timecourse_fits, width = 8, height = 6)
```

I is at steady state across the entire time course for all parameter sets.

Note that while the absolute amount of X is constrained by the data, the absolute amount of I is not. 

##### Fold change relative to time 0

```{r}
constitutive_I_norm_timecourse_fits <- constitutive_sims %>%
    ggplot(aes(t, I_fc)) +
    geom_line(aes(group = run), alpha = 0.25) +
    scale_y_log10() +
    xlab("Time (h)") +
    ylab("I (Fold change)") +
    labs(color = "log2(Cost)") +
    theme1
    ggtitle("Constitutive intracellular sFLT1 (I)")

# save plot
ggsave(out_png("constitutive_I_norm_timecourse_fits"),
       constitutive_I_norm_timecourse_fits, width = 8, height = 6)
    
constitutive_I_norm_timecourse_fits
```


##### Distribution of time 0 I amount

```{r}
constitutive_sims %>%
  filter(t == 0) %>%
  ggplot(aes(I_0, ..scaled..)) +
    geom_density(fill = cb_pal[3]) +
  scale_x_log10()
```


```{r}
constitutive_time0_I_dist <- constitutive_plot_time0_I_dist(constitutive_sims) +
  ggtitle("Constitutive - Distribution of initial I")

constitutive_time0_I_dist
```

```{r}
# save plot
ggsave(out_png("constitutive_time0_I_dist"),
       constitutive_time0_I_dist, width = 8, height = 6)
```

#### Pulse-chase intracellular

```{r}
pulsechase_opt_I_timecourse <- pulsechase_sims %>%
  ggplot(aes(t, I_fc)) +
  geom_line(aes(group = run), alpha = 0.1) +
  geom_point(data = jung, aes(time, lysate_fc, fill = "temp"),
             size = 5, shape = 21, color = "white", show.legend = TRUE) +
  scale_fill_manual(labels = "I", values = cb_pal[1]) +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = -20/60) +
  xlab("Time (h)") +
  ylab("I (fold change from t=0)") +
  labs(fill = "Observed data") +
  xlim(c(-1, 10)) +
  theme1 +
  theme(plot.title = element_text(size = 16)) +
  ggtitle("Pulse-chase intracellular sFLT1 (I)") +
  annotate("text", x = -0.7, y = 0.65, label = "Start pulse", angle = 90, size = 6) +
  annotate("text", x = 0.3, y = 0.4, label = "Start chase", angle = 90, size = 6)

pulsechase_opt_I_timecourse
```

```{r}
# save plot
ggsave(out_png("pulsechase_opt_I_timecourse"),
       pulsechase_opt_I_timecourse, width = 8, height = 6)
```

#### Pulse-chase extracellular

```{r}
pulsechase_opt_X_timecourse <- pulsechase_sims %>%
  ggplot(aes(t, X_frac)) +
  geom_line(aes(group = run), alpha = 0.1) +
  annotate("text", x = -0.75, y = 0.55, label = "Start pulse", angle = 90, size = 6) +
  annotate("text", x = 0.35, y = 0.75, label = "Start chase", angle = 90, size = 6) +
  geom_point(data = jung, aes(time, media_frac_max, fill = "temp"),
             size = 5, shape = 21, color = "white",
             show.legend = TRUE) +
  scale_fill_manual(labels = "X", values = cb_pal[2]) +
  geom_vline(xintercept = 0) +
  geom_vline(xintercept = -20/60) +
  ylim(c(-0.05, 1.2)) +
  xlim(c(-1, 10)) +
  #scale_color_viridis_b() +
  xlab("Time (h)") +
  ylab("X (Fraction of 8h amount)") +
  labs(fill = "Observed data") +
  theme1 +
  theme(plot.title = element_text(size = 16)) +
  ggtitle("Pulse-chase extracellular sFLT1 (X)")

pulsechase_opt_X_timecourse
```

```{r}
# save plot
ggsave(out_png("pulsechase_opt_X_timecourse"),
       pulsechase_opt_X_timecourse, width = 8, height = 6)
```

### Parameter values

#### Initial parameter values

##### Density - all on one grid

Plot all 6 parameters on a semilog scale.

```{r}
color_breaks <- levels(alt_param_df_new$parameter)
color_labels <- parse(text = color_breaks)

init_param_distr <- alt_param_df_new %>%
  ggplot(aes(initial, fill = parameter)) +
  geom_density(alpha =0.7) +
  scale_x_log10() +
  facet_wrap(~ parameter, scales = "free", labeller = label_parsed) +
  scale_fill_manual(values = param_pal, breaks = color_breaks, label = color_labels) +
  xlab("Initial value") +
  ylab("Density") +
  ggtitle("Initial parameter value distributions") +
  guides(fill = guide_legend(title = "Parameter")) +
  theme1

init_param_distr
```

```{r}
ggsave(out_png("init_param_distr"),
       init_param_distr, width = 8, height = 4)
```

##### Violin

```{r}
init_param_violin <- alt_param_df_new %>%
    ggplot(aes(initial, parameter, fill = parameter)) +
    geom_violin(scale = "width", trim = FALSE) +
    geom_boxplot(width = 0.3, fill = "white") +
    labs(fill = "Parameter") +
    scale_x_log10() +
  scale_y_discrete(labels = parse(text = param_names)) +
  scale_fill_manual(values = param_pal, breaks = color_breaks, label = color_labels) +
    xlab("Initial value") +
    ylab("Parameter") +
    ggtitle("Initial parameter value distributions") +
    theme1 +
    theme(plot.title = element_text(size = 24),
          text = element_text(size = 20),
          axis.text.y = element_text(size = 20),
          legend.position = "bottom") +
    guides(fill = guide_legend(nrow = 1))

init_param_violin
```

```{r}
# save plot
ggsave(out_png("init_param_violin"),
       init_param_violin, width = 7.5, height = 5)
```


#### Optimal parameter values

##### Density

```{r}
opt_param_distr <- alt_param_df_new %>%
    ggplot(aes(optimal, fill = parameter, ..scaled..)) +
    geom_density(alpha = 0.7, show.legend = FALSE) +
    scale_x_log10() +
    facet_wrap(~ parameter, scales = "free", labeller = label_parsed) +
    scale_fill_manual(values = param_pal) +
    xlab("Optimized value") +
    ylab("Scaled density") +
    ggtitle("Optimal parameter value distributions") +
    labs(fill = "Parameter") +
    theme1 +
    theme(plot.title = element_text(size = 24))

opt_param_distr
```

```{r}
# save plot
ggsave(out_png("opt_param_distr"),
       opt_param_distr, width = 9.9, height = 6.6)
```

##### Violin

```{r}
opt_param_violin <- alt_param_df_new %>%
    ggplot(aes(optimal, parameter, fill = parameter)) +
    geom_violin(scale = "width", trim = FALSE) +
    geom_boxplot(width = 0.3, fill = "white") +
    labs(fill = "Parameter") +
    scale_x_log10() +
    scale_y_discrete(labels = parse(text = param_names)) +
    scale_fill_manual(values = param_pal, breaks = color_breaks, label = color_labels) +
    xlab("Optimized value") +
    ylab("Parameter") +
    ggtitle("Optimal parameter value distributions") +
    theme1 +
    theme(plot.title = element_text(size = 24),
          text = element_text(size = 20),
          axis.text.y = element_text(size = 20),
          legend.position = "bottom") +
  guides(fill = guide_legend(nrow = 1))

opt_param_violin
```

```{r}
# save plot
ggsave(out_png("opt_param_violin"),
       opt_param_violin, width = 7.5, height = 5)
```

### Compound parameters

```{r}
param_df_wide <- param_df_wide %>%
  mutate(alpha_beta = alpha * beta,
         beta_plus_gamma = beta + gamma,
         calc_I_ss = alpha / beta_plus_gamma,
         alpha_beta_by_beta_plus_gamma = alpha_beta / beta_plus_gamma,
         calc_X_ss = alpha_beta / (delta * beta_plus_gamma))

param_df_wide
```

#### Statistics

```{r}
summary(param_df_wide)
```

#### Statistics

```{r}
param_df_wide %>%
  pivot_longer(names_to = "parameter", values_to = "value", cols = alpha:calc_X_ss) %>%
  group_by(parameter) %>%
  summarize(avg = mean(value),
            stdev = sd(value),
            coef_var = stdev/avg,
            med = median(value),
            mad = mad(value),
            iqr = IQR(value),
            iqr_v_median = iqr/med)
```

```{r}
param_df_wide %>%
  pivot_longer(names_to = "parameter", values_to = "value", cols = alpha:calc_X_ss) %>%
  group_by(parameter) %>%
  summarize(avg = mean(value),
            stdev = sd(value),
            coef_var = stdev/avg,
            med = median(value),
            mad = mad(value),
            iqr = IQR(value),
            iqr_v_median = iqr/med) %>%
  knitr::kable()
```

#### beta + gamma - density

(total I elimination rate constant)

Density - not very informative bc so narrow

```{r}
param_df_wide %>%
  ggplot(aes(beta_plus_gamma, ..scaled..)) +
  geom_density(fill = cb_pal[1], alpha = 0.5) +
  xlab(TeX(r'($\beta + \gamma$)')) +
  ylab("Scaled density") +
  ggtitle(TeX(r'(Distribution of $\beta + \gamma$)')) +
  theme1
```


#### alpha * beta: density

```{r}
param_df_wide %>%
  ggplot(aes(alpha_beta, ..scaled..)) +
  geom_density(fill = cb_pal[1], alpha = 0.5) +
  xlab(TeX(r'($\alpha \beta$)')) +
  ylab("Scaled density") +
  ggtitle(TeX(r'(Distribution of $\alpha \beta$)')) +
  theme1
```

#### alpha * beta / (beta + gamma): density


```{r}
param_df_wide %>%
  ggplot(aes(alpha_beta_by_beta_plus_gamma, ..scaled..)) +
  geom_density(fill = cb_pal[1], alpha = 0.5) +
  xlab(TeX(r'($\frac{\alpha \beta}{\beta + \gamma}$)')) +
  ylab("Scaled density") +
  ggtitle(TeX(r'(Distribution of $\frac{\alpha \beta}{\beta + \gamma}$)')) +
  theme1
```

#### alternate approach - init v opt

```{r}
alt_param_df_wide <- alt_param_df_new %>%
  pivot_longer(initial:optimal, names_to = "init_opt", values_to = "value") %>%
  select(run, init_opt, parameter, value) %>%
  pivot_wider(names_from = parameter, values_from = value) %>%
  mutate(alpha_beta = alpha * beta,
         beta_plus_gamma = beta + gamma,
         calc_I_ss = alpha / beta_plus_gamma,
         alpha_beta_by_beta_plus_gamma = alpha_beta / beta_plus_gamma,
         calc_X_ss = alpha_beta / (delta * beta_plus_gamma))

alt_param_df_wide
```


```{r}
alt_param_df_new
```


### Grouped distributions

#### Initial unfiltered and initial filtered distributions

##### alpha

```{r}
alpha_raw <- param_df %>%
  filter(parameter == "alpha", init_opt == "initial") %>%
  mutate(raw_filtered = "raw")

alpha_filtered <- param_df_new %>%
  filter(parameter == "alpha", init_opt == "initial") %>%
  mutate(raw_filtered = "filtered")

alpha_raw_filtered <- rbind(alpha_raw, alpha_filtered) %>%
  mutate(raw_filtered = factor(raw_filtered, levels = c("raw", "filtered"))) %>%
  ggplot(aes(value, fill = raw_filtered, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\alpha$ (1/h))')) +
  ggtitle(TeX(r'($\alpha$)')) +
  theme1

alpha_raw_filtered
```


##### beta

```{r}
beta_raw <- param_df %>%
  filter(parameter == "beta", init_opt == "initial") %>%
  mutate(raw_filtered = "raw")

beta_filtered <- param_df_new %>%
  filter(parameter == "beta", init_opt == "initial") %>%
  mutate(raw_filtered = "filtered")

beta_raw_filtered <- rbind(beta_raw, beta_filtered) %>%
  mutate(raw_filtered = factor(raw_filtered, levels = c("raw", "filtered"))) %>%
#  ggplot(aes(value, fill = raw_filtered)) +
  ggplot(aes(value, fill = raw_filtered, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\beta$ (1/h))')) +
  ggtitle(TeX(r'($\beta$)')) +
  theme1

beta_raw_filtered
```

##### gamma

```{r}
gamma_raw <- param_df %>%
  filter(parameter == "gamma", init_opt == "initial") %>%
  mutate(raw_filtered = "raw")

gamma_filtered <- param_df_new %>%
  filter(parameter == "gamma", init_opt == "initial") %>%
  mutate(raw_filtered = "filtered")

gamma_raw_filtered <- rbind(gamma_raw, gamma_filtered) %>%
  mutate(raw_filtered = factor(raw_filtered, levels = c("raw", "filtered"))) %>%
#  ggplot(aes(value, fill = raw_filtered)) +
  ggplot(aes(value, fill = raw_filtered, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\gamma$ (1/h))')) +
  ggtitle(TeX(r'($\gamma$)')) +
  theme1

gamma_raw_filtered
```

##### delta


```{r}
delta_raw <- param_df %>%
  filter(parameter == "delta", init_opt == "initial") %>%
  mutate(raw_filtered = "raw")

delta_filtered <- param_df_new %>%
  filter(parameter == "delta", init_opt == "initial") %>%
  mutate(raw_filtered = "filtered")

delta_raw_filtered <- rbind(delta_raw, delta_filtered) %>%
  mutate(raw_filtered = factor(raw_filtered, levels = c("raw", "filtered"))) %>%
  #ggplot(aes(value, fill = raw_filtered)) +
  ggplot(aes(value, fill = raw_filtered, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\delta$ (1/h))')) +
  ggtitle(TeX(r'($\delta$)')) +
  theme1

delta_raw_filtered
```

##### tau

```{r}
tau_raw <- param_df %>%
  filter(parameter == "tau", init_opt == "initial") %>%
  mutate(raw_filtered = "raw")

tau_filtered <- param_df_new %>%
  filter(parameter == "tau", init_opt == "initial") %>%
  mutate(raw_filtered = "filtered")

tau_raw_filtered <- rbind(tau_raw, tau_filtered) %>%
  mutate(raw_filtered = factor(raw_filtered, levels = c("raw", "filtered"))) %>%
  #ggplot(aes(value, fill = raw_filtered)) +
  ggplot(aes(value, fill = raw_filtered, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  #scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\tau$ (1/h))')) +
  ggtitle(TeX(r'($\tau$)')) +
  theme1

tau_raw_filtered
```

##### kappa

```{r}
kappa_raw <- param_df %>%
  filter(parameter == "kappa", init_opt == "initial") %>%
  mutate(raw_filtered = "raw")

kappa_filtered <- param_df_new %>%
  filter(parameter == "kappa", init_opt == "initial") %>%
  mutate(raw_filtered = "filtered")

kappa_raw_filtered <- rbind(kappa_raw, kappa_filtered) %>%
  mutate(raw_filtered = factor(raw_filtered, levels = c("raw", "filtered"))) %>%
  #ggplot(aes(value, fill = raw_filtered)) +
  ggplot(aes(value, fill = raw_filtered, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  #scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\kappa$ (1/h))')) +
  ggtitle(TeX(r'($\kappa$)')) +
  theme1

kappa_raw_filtered
```

##### Combined plot

```{r}
init_val_density_raw_filtered <- 
  (alpha_raw_filtered + beta_raw_filtered + gamma_raw_filtered) /
  (delta_raw_filtered + tau_raw_filtered + kappa_raw_filtered) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Initial parameter values"
  ) &
  theme(plot.title = element_text(size = 24, hjust = 0.5),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 20),
        legend.position = "bottom")

init_val_density_raw_filtered
```

```{r}
# save plot
ggsave(out_png("init_val_density_raw_filtered"),
       init_val_density_raw_filtered, width = 12, height = 6)
```


#### Initial and optimal distributions

##### alpha


```{r}
alpha_init_opt_density <- param_df_new %>%
  filter(parameter == "alpha") %>%
#  ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ggtitle(TeX(r'($\alpha$)')) +
  theme1

alpha_init_opt_density
```


##### beta

```{r}
beta_init_opt_density <- param_df_new %>%
  filter(parameter == "beta") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\beta$ (1/h))')) +
  ggtitle(TeX(r'($\beta$)')) +
  theme1

beta_init_opt_density
```

Note that the maximum optimal value of ~ 0.2 is not artificially imposed by optimization bounds - this is likely related to the convergence of (beta + gamma) to ~ 0.191.

##### gamma

```{r}
gamma_init_opt_density <- param_df_new %>%
  filter(parameter == "gamma") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\gamma$ (1/h))')) +
  ggtitle(TeX(r'($\gamma$)')) +
  theme1

gamma_init_opt_density
```

##### delta

```{r}
delta_init_opt_density <- param_df_new %>%
  filter(parameter == "delta") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\delta$ (1/h))')) +
  ggtitle(TeX(r'($\delta$)')) +
  theme1

delta_init_opt_density
```

##### tau

```{r}
tau_init_opt_density <- param_df_new %>%
  filter(parameter == "tau") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\tau$ (h))')) +
  ggtitle(TeX(r'($\tau$)')) +
  theme1

tau_init_opt_density
```

##### kappa

```{r}
kappa_init_opt_density <- param_df_new %>%
  filter(parameter == "kappa") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  #scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\kappa$ (1/h))')) +
  ggtitle(TeX(r'($\kappa$)')) +
  theme1

kappa_init_opt_density
```

##### Combined plot

```{r}
init_opt_density <- 
  (alpha_init_opt_density + beta_init_opt_density + gamma_init_opt_density) /
  (delta_init_opt_density + kappa_init_opt_density + tau_init_opt_density) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Distributions of core parameters"
  ) &
  theme(plot.title = element_text(size = 24, hjust = 0.5),
        legend.text = element_text(size = 18),
        legend.title = element_text(size = 20),
        legend.position = "bottom")

init_opt_density
```

```{r}
# save plot
ggsave(out_png("init_opt_density"),
       init_opt_density, width = 12, height = 6)
```

#### Calculated variables - initial and optimal

##### alpha times beta

```{r}
alpha_beta_init_opt_density <- alt_param_df_wide %>%
  ggplot(aes(alpha_beta, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\alpha \beta$ (#/cell/h^2))')) +
  ggtitle(TeX(r'($\alpha \beta$)')) +
  theme1

alpha_beta_init_opt_density
```

##### Beta plus gamma

```{r}
beta_plus_gamma_init_opt_density <- alt_param_df_wide %>%
  ggplot(aes(beta_plus_gamma, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\beta + \gamma$ (1/h))')) +
  ggtitle(TeX(r'($\beta + \gamma$)')) +
  theme1

beta_plus_gamma_init_opt_density
```

##### Combined plot

```{r}
calc_vars_init_opt_density <- 
  alpha_beta_init_opt_density + beta_plus_gamma_init_opt_density +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Distributions of calculated parameters"
  ) &
  theme(plot.title = element_text(size = 24, hjust = 0.5))

calc_vars_init_opt_density
```

```{r}
# save plot
ggsave(out_png("calc_vars_init_opt_density"),
       calc_vars_init_opt_density, width = 8, height = 4)
```


#

### Relationships between variables

#### Optimal vs initial

Plot optimal value vs initial value for the parameters being optimized.

```{r}
opt_v_init_scatter <- alt_param_df_new %>%
  ggplot(aes(initial, optimal, fill = parameter)) +
  geom_point(alpha = 0.25, color = "black", shape = 21) +
  facet_wrap(~ parameter, scales = "free", labeller = label_parsed) +
  scale_fill_manual(values = param_pal, breaks = color_breaks, label = color_labels) +
  theme1 +
  scale_x_log10() +
  scale_y_log10() +
  theme(plot.title = element_text(size = 24),
        strip.text = element_text(size = 20)) +
  xlab("Initial value") +
  ylab("Optimized value") +
  ggtitle("Optimized versus initial parameter values") +
  labs(fill = "Parameter") +
  guides(fill = guide_legend(override.aes = list(alpha = 1, size = 3)))

opt_v_init_scatter
```


```{r}
# save plot
ggsave(out_png("opt_v_init_scatter"),
       opt_v_init_scatter, width = 10, height = 5)
```

#### Parameter correlations

##### Standard correlogram


```{r}
corr_pair_plot <- param_df_wide %>%
  select(alpha:tau) %>%
  ggpairs(., upper = list(continuous = wrap('cor', size = 8)), labeller = label_parsed) +
  theme1 +
  theme(strip.text = element_text(size = 24),
        axis.text.x = element_text(angle = 45, hjust = 1))

corr_pair_plot
```



The most robust relationship is between gamma and beta, which are strictly linearly related ($r = 1$). alpha is moderately positively correlated to gamma ($r = .530$) and moderately negatively correlated to beta ($r = -.539$), with both of these relationships appearing hyperbolic rather than linear.

(Based on correlation coefficients alone, there is an apparent relationship between delta and both beta and gamma; however, because delta is extremely constrained around a fixed value of .02, these correlations appear driven by outliers rather than by true relationships between parameters.)

```{r}
# save plot
ggsave(out_png("corr_pair_plot"),
       corr_pair_plot, width = 15, height = 12)
```

##### alpha vs (beta + gamma)

```{r}
alpha_v_beta_plus_gamma <- alt_param_df_new %>%
  filter(parameter %in% c("alpha", "beta", "gamma")) %>%
  select(-initial, -total_cost) %>%
  pivot_wider(names_from = "parameter", values_from = "optimal") %>%
  mutate(beta_gamma = beta + gamma) %>%
  ggplot(aes(alpha, beta_gamma)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme1 +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ylab(TeX(r'($\beta + \gamma$ (1/h))'))

alpha_v_beta_plus_gamma
```

```{r}
# save plot
ggsave(out_png("alpha_v_beta_plus_gamma"),
       alpha_v_beta_plus_gamma, width = 4, height = 3)
```


The sum of beta and gamma is generally fixed around a constant value of 0.191.

##### I versus alpha/(beta+gamma)

```{r}
constitutive_df_72h <- constitutive_sims %>%
  filter(t == max(t)) %>%
  select(run, alpha = OPT_alpha, beta = OPT_beta, gamma = OPT_gamma, delta = OPT_delta,
         I_72 = I, X_72 = X, total_cost) %>%
  mutate(I_coeff = alpha / (beta + gamma))

I_obs_v_calc <- constitutive_df_72h  %>%
  ggplot(aes(I_coeff, I_72)) +
  geom_point(alpha = 0.3) +
  scale_x_log10() +
  scale_y_log10() +
  theme1 +
  xlab(TeX(r'($\frac{\alpha}{\beta + \gamma}$ (#/cell))')) +
  ylab(TeX(r'(Observed $\bar{I}$ (#/cell))')) #+
#  ggtitle(TeX(r'(Calculated and observed $\bar{I}$)'))

I_obs_v_calc
```

```{r}
# save plot
ggsave(out_png("I_obs_v_calc"),
       I_obs_v_calc, width = 4, height = 3)
```



```{r}
cor(constitutive_df_72h$I_72, constitutive_df_72h$I_coeff)
```

Consistent with the relationship derived using quasi-steady-state assumption, the steady state value of I was equal to the ratio $\frac{\alpha}{\beta + \gamma} == \frac{\mbox{alpha}}{\mbox{beta + gamma}}$.

The most robust relationships are:
- alpha vs beta
- alpha vs gamma
- beta vs gamma

##### alpha vs all

```{r}
param_df_wide %>%
  pivot_longer(cols = beta:tau, names_to = "parameter", values_to = "value") %>%
  ggplot(aes(alpha, value)) +
  geom_point(alpha = 0.3) +
  facet_wrap(~ parameter, scales = "free", labeller = label_parsed) +
  scale_x_continuous(trans = "log10", breaks = c(3e4, 3e5, 3e6)) +
  theme1 +
  xlab(expression(alpha))
```

##### alpha vs beta

```{r}
alpha_v_beta <- param_df_wide %>%
  ggplot(aes(alpha, beta)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(trans = "log10", breaks = c(3e4, 3e5, 3e6)) +
  #scale_y_log10() +
  #ggtitle("beta versus alpha") +
  theme1 +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ylab(TeX(r'($\beta$ (1/h))'))


alpha_v_beta
```

```{r}
# save plot
ggsave(out_png("alpha_v_beta"),
       alpha_v_beta, width = 4, height = 3)
```


Hyperbolic (not shown: log-log-linear) relationship: beta is determined by the value of alpha, with increased alpha associated with decreased beta.

##### alpha vs gamma

```{r}
alpha_v_gamma <- param_df_wide %>%
  ggplot(aes(alpha, gamma)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(trans = "log10", breaks = c(3e4, 3e5, 3e6)) +
  #scale_y_log10() +
  #ggtitle("gamma versus alpha") +
  theme1 +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ylab(TeX(r'($\gamma$ (1/h))'))

alpha_v_gamma
```

Hyperbolic relationship between alpha and gamma, with increased alpha associated with increased gamma (not shown - hyperbolic in all log/linear scale plots). Below a alpha threshold of ~ 3e4 #/cell/h, gamma goes to 0. (This is rational because below this threshold, all I made must be secreted rather than degraded in order to generate (or approach) the expected concentration of X.)

```{r}
# save plot
ggsave(out_png("alpha_v_gamma"),
       alpha_v_gamma, width = 4, height = 3)
```

##### alpha vs delta

```{r}
alpha_v_delta <- param_df_wide %>%
  ggplot(aes(alpha, delta)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(trans = "log10", breaks = c(3e4, 3e5, 3e6)) +
  #ggtitle("delta versus alpha") +
  theme1 +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ylab(TeX(r'($\delta$ (1/h))'))

alpha_v_delta
```

```{r}
summary(param_df_wide$delta)
```

For all values of alpha above a threshold of 3e4 #/cell/h, delta is essentially fixed at a value of .0204 1/h. Below that threshold, delta decreases. (This is rational because below this threshold, all secreted X must not be degraded in order to generate (or approach) the expected concentration of X.)

##### alpha vs tau

```{r}
alpha_v_tau <- param_df_wide %>%
  ggplot(aes(alpha, tau)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(trans = "log10", breaks = c(3e4, 3e5, 3e6)) +
  #ggtitle("tau versus alpha") +
  theme1 +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ylab(TeX(r'($\tau$ (1/h))'))

alpha_v_tau
```

```{r}
summary(param_df_wide$tau)
```

In most cases, tau is fixed at approximately 1.76 h. As with other parameters, this relationship becomes weaker when alpha < 3e4 #/cell/h.

##### alpha vs kappa

```{r}
alpha_v_kappa <- param_df_wide %>%
  ggplot(aes(alpha, kappa)) +
  geom_point(alpha = 0.5) +
  scale_x_continuous(trans = "log10", breaks = c(3e4, 3e5, 3e6)) +
  #ggtitle("kappa versus alpha") +
  theme1 +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ylab(TeX(r'($\kappa$ (1/h))'))

alpha_v_kappa
```

```{r}
summary(param_df_wide$kappa)
```

In most cases, tau is fixed at approximately 9.0 1/h. As with other parameters, this relationship becomes weaker when alpha < 3e4 #/cell/h.


##### beta vs gamma

```{r}
beta_v_gamma <- param_df_wide %>%
  ggplot(aes(beta, gamma)) +
  geom_point(alpha = 0.5) +
  #ggtitle("gamma versus beta") +
  theme1 +
  xlab(TeX(r'($\beta$ (1/h))')) +
  ylab(TeX(r'($\gamma$ (1/h))'))

beta_v_gamma
```

```{r}
# save plot
ggsave(out_png("beta_v_gamma"),
       beta_v_gamma, width = 4, height = 3)
```

There is a linear relationship between gamma and beta: as one increases, the other decreases such that the sum of gamma and beta is generally fixed around .191 (see distribution of beta + gamma)

##### beta vs delta

```{r}
beta_v_delta <- param_df_wide %>%
  filter(delta > 1e-5) %>%    # 33 outliers removed
  ggplot(aes(beta, delta)) +
  geom_point(alpha = 0.5) +
  #scale_x_log10() +
  #scale_y_log10() +
  #ggtitle("delta versus beta") +
  theme1 +
  xlab(TeX(r'($\beta$ (1/h))')) +
  ylab(TeX(r'($\delta$ (1/h))'))

beta_v_delta
```

For all values of beta, delta is essentially fixed at a value of .0204 1/h.

(The outliers at high beta and low delta correspond to very low alpha values, meaning that in order to reach desired X concentrations, all I must be secreted and no X must be degraded.)

##### beta vs tau

```{r}
beta_v_tau <- param_df_wide %>%
  ggplot(aes(beta, tau)) +
  geom_point(alpha = 0.5) +
  #ggtitle("tau versus beta") +
  theme1 +
  xlab(TeX(r'($\beta$ (1/h))')) +
  ylab(TeX(r'($\tau$ (h))'))

beta_v_tau
```

tau is fixed at 1.76 independent of beta.

##### beta vs_kappa

```{r}
beta_v_kappa <- param_df_wide %>%
  ggplot(aes(beta, kappa)) +
  geom_point(alpha = 0.5) +
  #ggtitle("kappa versus beta") +
  #scale_x_log10() +
  theme1 +
  xlab(TeX(r'($\beta$ (1/h))')) +
  ylab(TeX(r'($\kappa$ (1/h))'))

beta_v_kappa
```

kappa is fixed at 9.0 independent of beta.

##### gamma vs delta

```{r}
gamma_v_delta <- param_df_wide %>%
  ggplot(aes(gamma, delta)) +
  geom_point(alpha = 0.5) +
  #scale_x_log10() +
  #scale_y_log10() +
  #ggtitle("delta versus gamma") +
  theme1 +
  xlab(TeX(r'($\gamma$ (1/h))')) +
  ylab(TeX(r'($\delta$ (1/h))'))

gamma_v_delta
```

delta is fixed around .0204 independent of gamma.

##### gamma vs tau

```{r}
gamma_v_tau <- param_df_wide %>%
  ggplot(aes(gamma, tau)) +
  geom_point(alpha = 0.5) +
  #ggtitle("tau versus gamma") +
  theme1 +
  xlab(TeX(r'($\gamma$ (1/h))')) +
  ylab(TeX(r'($\tau$ (h))'))

gamma_v_tau
```

tau is fixed around 1.76 independent of gamma.

##### gamma vs_kappa

```{r}
gamma_v_kappa <- param_df_wide %>%
  ggplot(aes(gamma, kappa)) +
  geom_point(alpha = 0.5) +
  #ggtitle("kappa versus gamma") +
  #scale_x_log10() +
  theme1 +
  xlab(TeX(r'($\gamma$ (1/h))')) +
  ylab(TeX(r'($\kappa$ (1/h))'))

gamma_v_kappa
```

kappa is fixed around 9.0 independent of gamma.

##### delta vs tau

```{r}
delta_v_tau <- param_df_wide %>%
  ggplot(aes(delta, tau)) +
  geom_point(alpha = 0.5) +
  #ggtitle("tau versus delta") +
  theme1 +
  xlab(TeX(r'($\delta$ (1/h))')) +
  ylab(TeX(r'($\tau$ (h))'))

delta_v_tau
```

delta is fixed around .0204 and tau is fixed around 1.76, except for a handful of outliers.

##### delta vs_kappa

```{r}
delta_v_kappa <- param_df_wide %>%
  #filter(delta < 2) %>%     # 10 outliers removed
  filter(delta > 1e-5) %>%   # 33 outliers removed
  ggplot(aes(delta, kappa)) +
  geom_point(alpha = 0.5) +
  #ggtitle("kappa versus delta") +
  #scale_x_log10() +
  theme1 +
  xlab(TeX(r'($\delta$ (1/h))')) +
  ylab(TeX(r'($\kappa$ (1/h))'))

delta_v_kappa
```

delta is fixed around .0204 and kappa is fixed around 9.0, except for a handful of outliers.

##### tau vs_kappa

```{r}
tau_v_kappa <- param_df_wide %>%
  ggplot(aes(tau, kappa)) +
  geom_point(alpha = 0.5) +
  #ggtitle("kappa versus tau") +
  #scale_x_log10() +
  theme1 +
  xlab(TeX(r'($\tau$ (h))')) +
  ylab(TeX(r'($\kappa$ (1/h))'))

tau_v_kappa
```

tau is fixed around 1.76 and kappa is fixed around 9.0, except for a handful of outliers.

#### Combined plot

```{r}
combo_corr_plot <- alpha_v_beta + plot_spacer() + plot_spacer() + plot_spacer() + plot_spacer() + 
  alpha_v_gamma +beta_v_gamma + plot_spacer() + plot_spacer() + plot_spacer() + 
  alpha_v_delta + beta_v_delta + gamma_v_delta + plot_spacer() + plot_spacer() +
  alpha_v_tau + beta_v_tau + gamma_v_tau + delta_v_tau + plot_spacer() +
  alpha_v_kappa + beta_v_kappa + gamma_v_kappa + delta_v_kappa + tau_v_kappa +
  plot_layout(ncol = 5, nrow = 5)

combo_corr_plot
```

```{r}
# save plot
ggsave(out_png("combo_corr_plot"),
       combo_corr_plot, width = 15, height = 15)
```







### Initial and optimal distributions

#### alpha


```{r}
alpha_init_opt_density <- param_df_new %>%
  filter(parameter == "alpha") %>%
#  ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\alpha$ (#/cell/h))')) +
  ggtitle(TeX(r'($\alpha$)')) +
  theme1

alpha_init_opt_density
```



#### beta

```{r}
beta_init_opt_density <- param_df_new %>%
  filter(parameter == "beta") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\beta$ (1/h))')) +
  ggtitle(TeX(r'($\beta$)')) +
  theme1

beta_init_opt_density
```

Note that the maximum optimal value of ~ 0.2 is not artificially imposed by optimization bounds - this is likely related to the convergence of (beta + gamma) to ~ 0.191.

#### gamma

```{r}
gamma_init_opt_density <- param_df_new %>%
  filter(parameter == "gamma") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\gamma$ (1/h))')) +
  ggtitle(TeX(r'($\gamma$)')) +
  theme1

gamma_init_opt_density
```

#### delta

```{r}
delta_init_opt_density <- param_df_new %>%
  filter(parameter == "delta") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\delta$ (1/h))')) +
  ggtitle(TeX(r'($\delta$)')) +
  theme1

delta_init_opt_density
```

#### tau

```{r}
tau_init_opt_density <- param_df_new %>%
  filter(parameter == "tau") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\tau$ (h))')) +
  ggtitle(TeX(r'($\tau$)')) +
  theme1

tau_init_opt_density
```

#### kappa

```{r}
kappa_init_opt_density <- param_df_new %>%
  filter(parameter == "kappa") %>%
  #ggplot(aes(value, fill = init_opt)) +
  ggplot(aes(value, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  #scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\kappa$ (1/h))')) +
  ggtitle(TeX(r'($\kappa$)')) +
  theme1

kappa_init_opt_density
```

#### Combined plot

```{r}
init_opt_density <- 
  (alpha_init_opt_density + beta_init_opt_density + gamma_init_opt_density) /
  (delta_init_opt_density + kappa_init_opt_density + tau_init_opt_density) +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Distributions of core parameters"
  ) &
  theme(plot.title = element_text(size = 24, hjust = 0.5))

init_opt_density
```

```{r}
# save plot
ggsave(out_png("init_opt_density"),
       init_opt_density, width = 12, height = 6)
```

#### Calculated variables

```{r}
alpha_beta_init_opt_density <- alt_param_df_wide %>%
  ggplot(aes(alpha_beta, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\alpha \beta$ (#/cell/h^2))')) +
  ggtitle(TeX(r'($\alpha \beta$)')) +
  theme1

alpha_beta_init_opt_density
```

```{r}
beta_plus_gamma_init_opt_density <- alt_param_df_wide %>%
  ggplot(aes(beta_plus_gamma, fill = init_opt, ..scaled..)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = cb_pal[c(6,1)]) +
  scale_x_log10() +
  #scale_y_log10() +
  labs(fill = "Values") +
  ylab("Density") +
  xlab(TeX(r'($\beta + \gamma$ (1/h))')) +
  ggtitle(TeX(r'($\beta + \gamma$)')) +
  theme1

beta_plus_gamma_init_opt_density
```

```{r}
calc_vars_init_opt_density <- 
  alpha_beta_init_opt_density + beta_plus_gamma_init_opt_density +
  plot_layout(guides = "collect") +
  plot_annotation(
    title = "Distributions of calculated parameters"
  ) &
  theme(plot.title = element_text(size = 24, hjust = 0.5))

calc_vars_init_opt_density
```

```{r}
# save plot
ggsave(out_png("calc_vars_init_opt_density"),
       calc_vars_init_opt_density, width = 8, height = 4)
```




### Pulse-chase rate terms over time

#### Find I at t-tau in Pulse-chase sims

```{r}
pulsechase_I_t_minus_tau_list <- lapply(1:length(unique(pulsechase_sims$run)), function(x){
  
  # extract rows for the xth run
  temp_df <- pulsechase_sims %>%
    filter(run == unique(pulsechase_sims$run)[x])
  
  # find index to start recording I(t-tau)
  # (when t > tau - 1/3)
  offset <- sum(temp_df$t - temp_df$OPT_tau < -1/3)
  
  # find index to start copying I
  # (when t > -1/3)
  # (necessary because of the bonus -1h and duplicated -1/3h time points added for plotting)
  start_ind <- min(which(temp_df$t > round(-1/3,3)))
  
  # find index to end copying I
  # (when t > max(t) - tau)
  end_ind <- max(which(temp_df$t <= max(temp_df$t) - temp_df$OPT_tau))
  
  # initialize all I(t-tau) to 0
  I_t_minus_tau <- 0
  
  # set elements of I(t-tau) to desired elements of I
  I_t_minus_tau[(offset+1):nrow(temp_df)] <- temp_df$I[start_ind:end_ind]
  
  I_t_minus_tau
  
})

# combine values into single vector and add to simulation data frame
pulsechase_sims$I_t_minus_tau <- unlist(pulsechase_I_t_minus_tau_list)

# not quite sure why this introduced NAs instead of 0s - fix
pulsechase_sims <- pulsechase_sims %>%
  mutate(I_t_minus_tau = ifelse(is.na(I_t_minus_tau), 0, I_t_minus_tau))
```

#### Calculate rate terms at each time point

```{r}
pulsechase_sims <- pulsechase_sims %>%
  mutate(prod_t = case_when(t < -20/60 ~ 0,    # before t=-20, production = 0
                            t < 0 ~ OPT_alpha,    # between t=-20 and t=0, production = alpha
                            TRUE ~ OPT_alpha * exp(-OPT_kappa * t)), # after, prod = alpha * e^{-kappa*t}
         secr_t = OPT_beta * I_t_minus_tau,    # secretion = beta*I_{t-tau}
         deg_int_t = OPT_gamma * I_t_minus_tau,    # intracellular degr = gamma * I_(t-tau)  
         deg_ext_t = OPT_delta * X)    # extracellular degradation = delta * X
```


##### Adjust production at t = -20/60 to make step function

There are 2 data points at t=-20/60. One should be 0 and one should be prod, in that order. They should be adjacent to each other


```{r}
# set production at the first t = -0.333 point to 0
for (i in 1:nrow(pulsechase_sims)) {
  if (pulsechase_sims$t[i] == -0.333) {
#    print("Aha! Current t = -0.333")
    if (pulsechase_sims$t[i+1] == -0.333) {
#      print("Next t is also -0.333. Manually adjust production rate...")
      pulsechase_sims$prod_t[i] = 0
    } else{
#     print("No adjustment needed.") 
    }
  }
}
```



#### Plot production over time

Production = piecewise function

$$
t < -20/60: 0 \\
-20/60 \leq t< 0 : \alpha \\
t > 0: \alpha e^{-\kappa t}
$$

##### Absolute production - linear scale

```{r}
pulsechase_prod_v_time_linscale <- pulsechase_sims %>%
    ggplot(aes(t, prod_t)) +
    geom_line(aes(group = run), alpha = 0.1, color = cb_pal[3]) +
    annotate("text", x = -0.75, y = 4e6, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = 3.5e6, label = "Start chase", angle = 90, size = 6) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
  #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Production rate (#/cell/h)") +
    theme1 +
    ggtitle("Production rate over time - Pulse-chase case")

pulsechase_prod_v_time_linscale
```

```{r}
ggsave(out_png("pulsechase_prod_v_time_linscale"), pulsechase_prod_v_time_linscale, 
       width = 8, height = 6)
```


##### Absolute production - log scale

```{r}
pulsechase_prod_v_time_logscale <- pulsechase_sims %>%
    ggplot(aes(t, prod_t)) +
    geom_line(aes(group = run), alpha = 0.1, color = cb_pal[3]) +
    annotate("text", x = -0.65, y = 1e2, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.25, y = 1e1, label = "Start chase", angle = 90, size = 6) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
    scale_y_continuous(trans = "log10", limits = c(5e-1,5e6)) +
    xlab("Time (h)") +
    ylab("Production rate (#/cell/h)") +
    theme1 +
    ggtitle("Production rate over time - Pulse-chase case")

pulsechase_prod_v_time_logscale
```

Note the y-axis is truncated at 0.5 molecules/h, an arbitrary cutoff chosen as a biologically insignificant production rate.

```{r}
# save plot
ggsave(out_png("pulsechase_prod_v_time_logscale"), pulsechase_prod_v_time_logscale, 
       width = 8, height = 6)
```


##### Fraction of max production

```{r}
pulsechase_prod_v_time_frac_max <- pulsechase_sims %>%
  mutate(prod_t_frac = prod_t / OPT_alpha) %>%
    ggplot(aes(t, prod_t_frac)) +
    annotate("text", x = -0.75, y = .85, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = .75, label = "Start chase", angle = 90, size = 6) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
  #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Production rate (Fraction of maximum)") +
    theme1 +
    ggtitle("sFLT1 production rate over time  - pulse-chase case")

pulsechase_prod_v_time_frac_max
```

```{r}
# save plot
ggsave(out_png("pulsechase_prod_v_time_frac_max"), pulsechase_prod_v_time_frac_max, 
       width = 8, height = 6)
```



#### Plot secretion over time

```{r}
pulsechase_secr_v_time_linscale <- pulsechase_sims %>%
    ggplot(aes(t, secr_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
    annotate("text", x = -0.75, y = 2250, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = 2000, label = "Start chase", angle = 90, size = 6) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
  #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Secretion rate (#/cell/h)") +
    theme1 +
    ggtitle("Secretion rate over time - Pulse-chase case")

pulsechase_secr_v_time_linscale
```

```{r}
# save plot
ggsave(out_png("pulsechase_secr_v_time_linscale"), pulsechase_secr_v_time_linscale, 
       width = 8, height = 6)
```

#### Plot intracellular degradation over time

##### Absolute intracellular degradation, linear scale

```{r}
pulsechase_intdeg_v_time_linscale <- pulsechase_sims %>%
    ggplot(aes(t, deg_int_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
    annotate("text", x = -0.75, y = 4e5, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = 3e5, label = "Start chase", angle = 90, size = 6) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
  #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Intracellular degradation rate (#/cell/h)") +
    theme1 +
    ggtitle("Intracellular degradation rate over time - Pulse-chase case")

pulsechase_intdeg_v_time_linscale
```

```{r}
# save plot
ggsave(out_png("pulsechase_intdeg_v_time_linscale"), pulsechase_intdeg_v_time_linscale, 
       width = 8, height = 6)
```

##### Absolute intracellular degradation, log scale

```{r}
pulsechase_intdeg_v_time_logscale <- pulsechase_sims %>%
    ggplot(aes(t, deg_int_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
    annotate("text", x = -0.75, y = 1e3, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = 1e2, label = "Start chase", angle = 90, size = 6) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
    scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Intracellular degradation rate (#/cell/h)") +
    theme1 +
    ggtitle("Intracellular degradation rate over time - Pulse-chase case")

pulsechase_intdeg_v_time_logscale
```

```{r}
# save plot
ggsave(out_png("pulsechase_intdeg_v_time_logscale"), pulsechase_intdeg_v_time_logscale, 
       width = 8, height = 6)
```

##### Fraction of maximum intracellular degradation

```{r}
pulsechase_intdeg_v_time_frac_max <- pulsechase_sims %>%
  group_by(run) %>%
  summarize(max_int_deg = max(deg_int_t)) %>%
  right_join(pulsechase_sims) %>%
  mutate(deg_int_frac = deg_int_t / max_int_deg) %>%
  ggplot(aes(t,deg_int_frac)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
    annotate("text", x = -0.75, y = 0.85, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = 0.75, label = "Start chase", angle = 90, size = 6) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
    #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Intracellular degradation rate (fraction of maximum)") +
    theme1 +
    ggtitle("Intracellular degradation rate over time - Pulse-chase case")

pulsechase_intdeg_v_time_frac_max
```

```{r}
# save plot
ggsave(out_png("pulsechase_intdeg_v_time_frac_max"), pulsechase_intdeg_v_time_frac_max, 
       width = 8, height = 6)
```


#### Plot extracellular degradation over time

```{r}
pulsechase_extdeg_v_time_linscale <- pulsechase_sims %>%
    ggplot(aes(t, deg_ext_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
    annotate("text", x = -0.75, y = 5e-4, label = "Start pulse", angle = 90, size = 6) +
    annotate("text", x = 0.35, y = 4e-4, label = "Start chase", angle = 90, size = 6) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
    geom_vline(xintercept = 0) +
    geom_vline(xintercept = -20/60) +
    xlim(c(-1, 10)) +
  #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Extracellular degradation rate (#/cell/h)") +
    theme1 +
    ggtitle("Extracellular degradation rate over time - pulse-chase case")

pulsechase_extdeg_v_time_linscale
```

```{r}
# save plot
ggsave(out_png("pulsechase_extdeg_v_time_linscale"), pulsechase_extdeg_v_time_linscale, 
       width = 8, height = 6)
```

### Constitutive rate terms over time

#### Find I at t-tau in Constitutive sims

```{r}
constitutive_I_t_minus_tau_list <- lapply(1:length(unique(constitutive_sims$run)), function(x){
  
  # extract rows for the xth run
  temp_df <- constitutive_sims %>%
    filter(run == unique(constitutive_sims$run)[x])
  
  # find index to start recording I(t-tau)
  # (when t > tau)
  offset <- sum(temp_df$t - temp_df$OPT_tau < 0)
  
  # find index to end copying I
  # (when t > max(t) - tau)
  end_ind <- max(which(temp_df$t <= max(temp_df$t) - temp_df$OPT_tau))
  
  # initialize all I(t-tau) to 0
  I_t_minus_tau <- 0
  
  # set elements of I(t-tau) to desired elements of I
  I_t_minus_tau[(offset+1):nrow(temp_df)] <- temp_df$I[1:end_ind]
  
  # set earlier elements of I to I at time 0
  I_t_minus_tau[1:offset] <- temp_df$I_0[1]
  
  I_t_minus_tau
  
})

# combine values into single vector and add to simulation data frame
constitutive_sims$I_t_minus_tau <- unlist(constitutive_I_t_minus_tau_list)

# not quite sure why this introduced NAs instead of 0s - fix
constitutive_sims <- constitutive_sims %>%
  mutate(I_t_minus_tau = ifelse(is.na(I_t_minus_tau), 0, I_t_minus_tau))
```


#### Calculate rate terms at each time point

```{r}
constitutive_sims <- constitutive_sims %>%
  mutate(prod_t =  OPT_alpha,    # production = alpha
         secr_t = OPT_beta * I_t_minus_tau,    # secretion = beta*I_{t-tau}
         deg_int_t = OPT_gamma * I_t_minus_tau,    # intracellular degr = gamma * I_(t-tau)  
         deg_ext_t = OPT_delta * X)    # extracellular degradation = delta * X
```


#### Plot production over time

##### Absolute production - linear scale

```{r}
constitutive_prod_v_time_linscale <- constitutive_sims %>%
    ggplot(aes(t, prod_t)) +
    geom_line(aes(group = run), alpha = 0.2, color = cb_pal[3]) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
#scale_y_log10() +
    xlab("Time (h)") +
    ylab("Production rate (#/cell/h)") +
    theme1 +
    ggtitle("Production rate over time - constitutive secretion")

constitutive_prod_v_time_linscale
```

```{r}
ggsave(out_png("constitutive_prod_v_time_linscale"), constitutive_prod_v_time_linscale, 
       width = 8, height = 6)
```

##### Absolute production - log scale

```{r}
constitutive_prod_v_time_logscale <- constitutive_sims %>%
    ggplot(aes(t, prod_t)) +
    geom_line(aes(group = run), alpha = 0.2, color = cb_pal[3]) +
    scale_fill_manual(labels = "X", values = cb_pal[2]) +
  scale_y_log10() +
    xlab("Time (h)") +
    ylab("Production rate (#/cell/h)") +
    theme1 +
    ggtitle("Production rate over time - constitutive secretion")

constitutive_prod_v_time_logscale
```


```{r}
ggsave(out_png("constitutive_prod_v_time_logscale"), constitutive_prod_v_time_logscale, 
       width = 8, height = 6)
```


##### Production rate distribution

```{r}
constitutive_prod_dist <- constitutive_sims %>% 
  filter(t == max(t)) %>%
  ggplot(aes(prod_t, ..scaled..)) +
  geom_density(fill = cb_pal[1], alpha = 0.5) +
  scale_x_log10() +
  xlab("Production rate (#/cell/h)") +
  ylab("Scaled density") +
  ggtitle("Constant production rate - constitutive secretion") +
  theme1

constitutive_prod_dist
```

Note that the production rate has the same distribution as alpha because in this system the production rate equals alpha.

```{r}
ggsave(out_png("constitutive_prod_dist"), constitutive_prod_dist, 
       width = 8, height = 6)
```

#### Plot secretion over time

##### Absolute secretion rate over time

```{r}
constitutive_secr_v_time_linscale <- constitutive_sims %>%
    ggplot(aes(t, secr_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
  #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Secretion rate (#/cell/h)") +
    theme1 +
    ggtitle("Secretion rate over time - constitutive secretion")

constitutive_secr_v_time_linscale
```

```{r}
ggsave(out_png("constitutive_secr_v_time_linscale"), constitutive_secr_v_time_linscale, 
       width = 8, height = 6)
```

##### Secretion rate distribution

```{r}
constitutive_secr_dist <- constitutive_sims %>% 
  filter(t == max(t)) %>%
  ggplot(aes(secr_t, ..scaled..)) +
  geom_density(fill = cb_pal[1], alpha = 0.5) +
  xlab("Secretion rate (#/cell/h)") +
  ylab("Scaled density") +
  ggtitle("Constant secretion rate - constitutive secretion") +
  theme1

constitutive_secr_dist
```

The model predicts a constitutive sFLT1 secretion rate of approximately 26,600 #/cell/h.

```{r}
ggsave(out_png("constitutive_secr_dist"), constitutive_secr_dist, 
       width = 8, height = 6)
```

#### Plot intracellular degradation over time

##### Absolute intracellular degradation, linear scale

```{r}
constitutive_intdeg_v_time_linscale <- constitutive_sims %>%
    ggplot(aes(t, deg_int_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
  #scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Intracellular degradation rate (#/cell/h)") +
    theme1 +
    ggtitle("Intracellular degradation rate over time - Constitutive secretion")

constitutive_intdeg_v_time_linscale
```

```{r}
# save plot
ggsave(out_png("constitutive_intdeg_v_time_linscale"), constitutive_intdeg_v_time_linscale, 
       width = 8, height = 6)
```

##### Absolute intracellular degradation, log scale

```{r}
constitutive_intdeg_v_time_logscale <- constitutive_sims %>%
    ggplot(aes(t, deg_int_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
    scale_y_log10() +
    #scale_color_viridis_b() +
    xlab("Time (h)") +
    ylab("Intracellular degradation rate (#/cell/h)") +
    theme1 +
    ggtitle("Intracellular degradation rate over time - Constitutive secretion")

constitutive_intdeg_v_time_logscale
```

```{r}
# save plot
ggsave(out_png("constitutive_intdeg_v_time_logscale"), constitutive_intdeg_v_time_logscale, 
       width = 8, height = 6)
```

##### Intracellular degradation rate distribution

```{r}
constitutive_intdeg_dist <- constitutive_sims %>% 
  filter(t == max(t)) %>%
  ggplot(aes(deg_int_t, ..scaled..)) +
  geom_density(fill = cb_pal[1], alpha = 0.5) +
  scale_x_log10() +
  xlab("Intracellular degradation rate (#/cell/h)") +
  ylab("Scaled density") +
  ggtitle("Constant intracellular degradation rate - constitutive secretion") +
  theme1

constitutive_intdeg_dist
```

The model predicts that during constitutive secretion, intracellular degradation is constant for any given parameter set but can vary over orders of magnitude across parameter sets.

```{r}
ggsave(out_png("constitutive_intdeg_dist"), constitutive_intdeg_dist, 
       width = 8, height = 6)
```



#### Plot extracellular degradation over time

```{r}
constitutive_extdeg_v_time_linscale <- constitutive_sims %>%
    ggplot(aes(t, deg_ext_t)) +
    geom_line(aes(group = run), alpha = 0.3, color = cb_pal[3]) +
  #scale_y_log10() +
    xlab("Time (h)") +
    ylab("Extracellular degradation rate (#/cell/h)") +
    theme1 +
    ggtitle("Extracellular degradation rate over time - constitutive secretion")

constitutive_extdeg_v_time_linscale
```

```{r}
# save plot
ggsave(out_png("constitutive_extdeg_v_time_linscale"), constitutive_extdeg_v_time_linscale, 
       width = 8, height = 6)
```

## CUTOFF - functional ^, in progress v

### Add I_ss to param_df_wide

```{r}
param_df_wide <- constitutive_sims %>%
  filter(t == max(t)) %>%
  select(run, I_ss = I) %>%
  right_join(param_df_wide, by = "run")
```

### Plot I_ss distribution

```{r}
I_ss_dist <- param_df_wide %>%
  ggplot(aes(I_ss, ..scaled..)) +
  geom_density(fill = cb_pal[1], alpha = .5) +
  scale_x_log10() +
  ggtitle("Steady state intracellular sFLT1 values") +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab("Scaled density") +
  theme1

I_ss_dist
```

```{r}
# save plot
ggsave(out_png("I_ss_dist"), I_ss_dist, width = 8, height = 6)
```

```{r}
param_df_wide %>%
  pull(I_ss) %>%
  summary(.)
```


```{r}
param_df_wide %>%
  mutate(alpha_beta = alpha*beta,
         beta_plus_gamma = beta + gamma,
         cx_div_cisq = alpha_beta / (beta_plus_gamma^2)) %>%
  pull(cx_div_cisq) %>%
  summary(.)
```

In all cases, $\bar{S_i} \geq \frac{c_I}{c_X}$.

```{r}
param_df_wide %>%
  mutate(alpha_beta = alpha*beta,
         beta_plus_gamma = beta + gamma,
         cx_div_cisq = alpha_beta / (beta_plus_gamma^2),
         check_Iss = I_ss >= cx_div_cisq) %>%
  pull(check_Iss) %>%
  all(.)
```



### Plot alpha vs I_ss

```{r}
constitutive_alpha_v_Iss <- param_df_wide %>%
  ggplot(aes(I_ss, alpha)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme1 +
  ggtitle(TeX(r'($\alpha$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\alpha$)'))

  #ggtitle(TeX(r'("$\alpha$ versus $\bar{I}$)"')))

constitutive_alpha_v_Iss
```

```{r}
# save plot
ggsave(out_png("constitutive_alpha_v_Iss"),
       constitutive_alpha_v_Iss, width = 8, height = 6)
```

#### I_ss v alpha

```{r}
param_df_wide
```


```{r}
constitutive_Iss_v_alpha <- param_df_wide %>%
  ggplot(aes(alpha, I_ss)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme1 +
  #ggtitle(TeX(r'($\bar{S_i}$ versus $\alpha$)')) +
  ylab(TeX(r'($\bar{S_i}$)')) +
  xlab(TeX(r'($\alpha$)'))


constitutive_Iss_v_alpha
```

```{r}
# save plot
ggsave(out_png("constitutive_Iss_v_alpha"),
       constitutive_Iss_v_alpha, width = 4, height = 3)
```


### Plot beta vs I_ss


```{r}
constitutive_beta_v_Iss <- param_df_wide %>%
  ggplot(aes(I_ss, beta)) +
  geom_point() +
  scale_x_log10() +
  #scale_y_log10() +
  theme1 +
  ggtitle(TeX(r'($\beta$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\beta$)'))

constitutive_beta_v_Iss
```

```{r}
# save plot
ggsave(out_png("constitutive_beta_v_Iss"),
       constitutive_beta_v_Iss, width = 8, height = 6)
```

#### I_ss v beta

```{r}
constitutive_Iss_v_beta <- param_df_wide %>%
  ggplot(aes(beta, I_ss)) +
  geom_point() +
  #scale_x_log10() +
  scale_y_log10() +
  theme1 +
  #ggtitle(TeX(r'($\bar{S_i}$ versus $\beta$)')) +
  xlab(TeX(r'($\beta$)')) +
  ylab(TeX(r'($\bar{S_i}$)'))

constitutive_Iss_v_beta
```

```{r}
# save plot
ggsave(out_png("constitutive_Iss_v_beta"),
       constitutive_Iss_v_beta, width = 4, height = 3)
```


### Plot gamma vs I_ss

```{r}
constitutive_gamma_v_Iss <- param_df_wide %>%
  ggplot(aes(I_ss, gamma)) +
  geom_point() +
  scale_x_log10() +
  #scale_y_log10() +
  theme1 +
  ggtitle(TeX(r'($\gamma$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\gamma$)'))

constitutive_gamma_v_Iss
```

```{r}
# save plot
ggsave(out_png("constitutive_gamma_v_Iss"),
       constitutive_gamma_v_Iss, width = 8, height = 6)
```

#### I_ss v gamma

```{r}
constitutive_Iss_v_gamma <- param_df_wide %>%
  ggplot(aes(I_ss, gamma)) +
  geom_point() +
  scale_x_log10() +
  #scale_y_log10() +
  theme1 +
  #ggtitle(TeX(r'($\bar{S_i}$ versus $\gamma$)')) +
  ylab(TeX(r'($\bar{S_i}$)')) +
  xlab(TeX(r'($\gamma$)'))

constitutive_Iss_v_gamma
```

```{r}
# save plot
ggsave(out_png("constitutive_Iss_v_gamma"),
       constitutive_Iss_v_gamma, width = 4, height = 3)
```


### Plot beta+gamma vs I_ss

```{r}
constitutive_betagamma_v_Iss <- param_df_wide %>%
  mutate(betagamma = beta + gamma) %>%
  ggplot(aes(I_ss, betagamma)) +
  geom_point() +
  scale_x_log10() +
  scale_y_continuous(limits = c(.19, .192)) +
  theme1 +
  ggtitle(TeX(r'($\beta + \gamma$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\beta + \gamma$)'))

constitutive_betagamma_v_Iss
```

```{r}
# save plot
ggsave(out_png("constitutive_betagamma_v_Iss"),
       constitutive_betagamma_v_Iss, width = 8, height = 6)
```

#### I_ss v beta + gamma

```{r}
constitutive_Iss_v_betagamma <- param_df_wide %>%
  mutate(betagamma = beta + gamma) %>%
  ggplot(aes(betagamma, I_ss)) +
  geom_point() +
  scale_y_log10() +
  scale_x_continuous(limits = c(.19, .192)) +
  theme1 +
  #ggtitle(TeX(r'($\bar{S_i}$ versus $\beta + \gamma$)')) +
  ylab(TeX(r'($\bar{S_i}$)')) +
  xlab(TeX(r'($\beta + \gamma$)'))

constitutive_Iss_v_betagamma
```

```{r}
# save plot
ggsave(out_png("constitutive_Iss_v_betagamma"),
       constitutive_Iss_v_betagamma, width = 4, height = 3)
```

### Plot alpha/beta+gamma vs I_ss

```{r}
constitutive_abg_v_Iss <- param_df_wide %>%
  mutate(abg = alpha / (beta + gamma)) %>%
  ggplot(aes(I_ss, abg)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme1 +
  ggtitle(TeX(r'($\frac{\alpha}{\beta + \gamma}$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\frac{\alpha}{\beta + \gamma}$)'))

constitutive_abg_v_Iss
```

```{r}
# save plot
ggsave(out_png("constitutive_abg_v_Iss"),
       constitutive_abg_v_Iss, width = 8, height = 6)
```

#### Plot I_ss v alpha/(beta+gamma)

```{r}
constitutive_Iss_v_abg <- param_df_wide %>%
  mutate(abg = alpha / (beta + gamma)) %>%
  ggplot(aes(abg, I_ss)) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10() +
  theme1 +
  #ggtitle(TeX(r'($\bar{S_i}$ versus $\frac{\alpha}{\beta + \gamma}$)')) +
  ylab(TeX(r'($\bar{S_i}$)')) +
  xlab(TeX(r'($\frac{\alpha}{\beta + \gamma}$)'))

constitutive_Iss_v_abg
```

```{r}
# save plot
ggsave(out_png("constitutive_Iss_v_abg"),
       constitutive_Iss_v_abg, width = 4, height = 3)
```

### Plot alpha/I_ss vs beta+gamma

#### Distr of alpha/I

(same as beta+gamma)

```{r}
param_df_wide %>%
  mutate(a_I_ratio = alpha / I_ss) %>%
  ggplot(aes(a_I_ratio)) +
  geom_boxplot() +
  theme1 +
  scale_y_continuous(breaks = NULL) +
  xlab(TeX(r'($\frac{\alpha}{\bar{S_i}}$)')) +
  xlim(c(.19, .2)) +
  ggtitle(TeX(r'(Distribution of $\frac{\alpha}{\bar{S_i}}$)'))
```

#### alpha/I 

```{r}
constitutive_betagamma_vs_aI <- param_df_wide %>%
  mutate(a_I_ratio = alpha / I_ss,
         betagamma = beta + gamma) %>%
  ggplot(aes(a_I_ratio, betagamma)) +
  geom_point(alpha = 0.5) +
  xlab(TeX(r'($\frac{\alpha}{\bar{S_i}}$)')) +
  ylab(TeX(r'($\beta + \gamma$)')) +
  ggtitle(TeX(r'($\beta + \gamma$ versus $\frac{\alpha}{\bar{S_i}}$)')) +
  theme1

constitutive_betagamma_vs_aI
```



### Plot delta vs I_ss (expect independent bc delta fixed)

```{r}
param_df_wide %>%
  ggplot(aes(I_ss, delta)) +
  geom_point() +
  scale_x_log10() +
  #scale_y_log10() +
  theme1 +
  ggtitle(TeX(r'($\delta$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\delta$)'))
```

### Plot kappa vs I_ss (expect independent bc kappa fixed)

```{r}
param_df_wide %>%
  ggplot(aes(I_ss, kappa)) +
  geom_point() +
  scale_x_log10() +
  #scale_y_log10() +
  theme1 +
  ggtitle(TeX(r'($\kappa$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\kappa$)'))
```

### Plot tau vs I_ss (expect independent bc tau fixed)

```{r}
param_df_wide %>%
  ggplot(aes(I_ss, tau)) +
  geom_point() +
  scale_x_log10() +
  #scale_y_log10() +
  theme1 +
  ggtitle(TeX(r'($\tau$ versus $\bar{S_i}$)')) +
  xlab(TeX(r'($\bar{S_i}$)')) +
  ylab(TeX(r'($\tau$)'))
```






## CUTOFF - in progress ^, brainstorming v

#### Greek translation

- Production
  - constitutive: $\alpha$
  - pulse-chase: (double check) = $\alpha e^{-\kappa t}$
- Secretion = $\beta S_i(t - \tau)$
- Intracellular degradation: $\gamma S_i(t - \tau)$
- Extracellular degradation: $\delta S_x(t)$

### Future - switch to greek letters

That's best done from the import/wrangling script.

Will also have to figure out how to label plots etc in latex










